import axios from 'axios'
import { config } from '../config'

const api = axios.create({
  // Always use configured API base URL so dev can target Render or local
  baseURL: config.API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
})

api.interceptors.request.use(
  (config) => {
    console.log('ü§ñ Digital Human API Request:', config.method?.toUpperCase(), config.url)
    if (config.data && config.method !== 'get') {
      console.log('üì§ Request Data:', config.data)
    }
    return config
  },
  (error) => {
    console.error('‚ùå API Request Error:', error)
    return Promise.reject(error)
  }
)

api.interceptors.response.use(
  (response) => {
    console.log('‚úÖ Digital Human API Response:', response.status, response.config.url)
    if (response.data) {
      console.log('üì• Response Data:', response.data)
    }
    return response
  },
  (error) => {
    console.error('‚ùå API Response Error:', {
      status: error.response?.status,
      statusText: error.response?.statusText,
      data: error.response?.data,
      url: error.config?.url,
      method: error.config?.method
    })
    return Promise.reject(error)
  }
)

export const digitalHumanAPI = {
  async startInterview(roomId: string, userId: string): Promise<{ agentInstanceId: string; digitalHumanTaskId: string; digitalHumanVideoStreamId: string }> {
    try {
      const requestData = {
        room_id: roomId,
        user_id: userId,
        user_stream_id: `${userId}_stream`,
        digital_human_id: 'c4b56d5c-db98-4d91-86d4-5a97b507da97' // Test digital human ID
      }
      
      console.log('üöÄ Starting digital human interview with AI Agent and video stream:', requestData)
      
      const response = await api.post('/api/start-digital-human', requestData)
      
      if (!response.data || !response.data.success) {
        throw new Error(response.data?.error || 'Digital human interview start failed')
      }
      
      if (!response.data.agentInstanceId || !response.data.digitalHumanTaskId) {
        throw new Error('Missing required IDs in response')
      }
      
      console.log('‚úÖ Digital human interview started successfully:', {
        agentInstanceId: response.data.agentInstanceId,
        digitalHumanTaskId: response.data.digitalHumanTaskId,
        digitalHumanVideoStreamId: response.data.digitalHumanVideoStreamId
      })
      
      return {
        agentInstanceId: response.data.agentInstanceId,
        digitalHumanTaskId: response.data.digitalHumanTaskId,
        digitalHumanVideoStreamId: response.data.digitalHumanVideoStreamId
      }
    } catch (error: any) {
      console.error('‚ùå Start digital human interview failed:', error.response?.data || error.message)
      throw new Error(error.response?.data?.error || error.message || 'Failed to start digital human interview')
    }
  },

  async stopInterview(agentInstanceId: string, digitalHumanTaskId: string): Promise<void> {
    if (!agentInstanceId || !digitalHumanTaskId) {
      console.warn('‚ö†Ô∏è Missing agent instance ID or digital human task ID')
      return
    }

    try {
      // Stop AI Agent
      console.log('üõë Stopping AI Agent instance:', agentInstanceId)
      const agentResponse = await api.post('/api/stop', {
        agent_instance_id: agentInstanceId
      })
      
      if (agentResponse.data?.success) {
        console.log('‚úÖ AI Agent stopped successfully')
      } else {
        console.warn('‚ö†Ô∏è AI Agent stop returned non-success:', agentResponse.data)
      }

      // Stop Digital Human
      console.log('üõë Stopping Digital Human stream task:', digitalHumanTaskId)
      const digitalHumanResponse = await api.post('/api/stop-digital-human', {
        task_id: digitalHumanTaskId
      })
      
      if (digitalHumanResponse.data?.success) {
        console.log('‚úÖ Digital Human stream task stopped successfully')
      } else {
        console.warn('‚ö†Ô∏è Digital Human stream task stop returned non-success:', digitalHumanResponse.data)
      }

    } catch (error: any) {
      console.error('‚ùå Stop digital human interview failed:', error.response?.data || error.message)
      throw new Error(error.response?.data?.error || error.message || 'Failed to stop digital human interview')
    }
  },

  async getToken(userId: string, roomId?: string): Promise<{ token: string }> {
    if (!userId) {
      throw new Error('User ID is required')
    }

    try {
      console.log('üîë Getting token for digital human user:', userId, 'roomId:', roomId)

      const params = new URLSearchParams({ user_id: userId })
      if (roomId) {
        params.append('room_id', roomId)
      }

      const response = await api.get(`/api/token?${params.toString()}`)

      if (!response.data || !response.data.token) {
        throw new Error('No token returned')
      }

      console.log('‚úÖ Digital human token received successfully')

      return { token: response.data.token }
    } catch (error: any) {
      console.error('‚ùå Get digital human token failed:', error.response?.data || error.message)
      throw new Error(error.response?.data?.error || error.message || 'Failed to get digital human token')
    }
  },

  async healthCheck(): Promise<{ status: string }> {
    try {
      console.log('üè• Checking digital human backend health')
      
      const response = await api.get('/health')
      
      console.log('‚úÖ Digital human backend health check successful:', response.data)
      
      return response.data
    } catch (error: any) {
      console.error('‚ùå Digital human backend health check failed:', error.response?.data || error.message)
      throw new Error(error.response?.data?.error || error.message || 'Digital human backend health check failed')
    }
  }
}
